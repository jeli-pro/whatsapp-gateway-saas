plan:
  id: "refactor-gateway-to-meet-readme-v1"
  status: "todo"
  title: "Refactor Gateway and Provider to Align with README Architecture"
  introduction: |
    The current implementation provides a solid foundation for a multi-provider WhatsApp gateway. However, a critical analysis reveals a significant delta between the features advertised in `README.md` and the actual coded implementation. The README promises zero-downtime migration, robust container management, and a scalable architecture, but the current service relies on brittle shell commands and lacks the core migration orchestration logic.

    This plan rectifies these shortcomings. We will rip out the `Bun.spawn` based Docker controls and replace them with a proper API client (`dockerode`) for type-safe, programmatic container management. Following this foundational refactor, we will implement the missing migration API endpoint, delivering on the zero-downtime promise. Finally, we will enhance the provider's state management to make it more configurable and to provide better status feedback to the gateway, creating a more cohesive and manageable system.
  parts:
    - id: "d0c4e40d-d434-45e0-9411-a3f25d97793d"
      status: "todo"
      isolation: false
      name: "Part 1: Refactor Docker Service to Use `dockerode`"
      reason: |
        The current `docker.service.ts` shells out to the `docker` CLI via `Bun.spawn`. This is brittle, insecure, and doesn't scale. It relies on parsing string output and is susceptible to command injection vulnerabilities. The presence of `@types/dockerode` in `devDependencies` suggests this was the intended path.

        By switching to `dockerode`, we gain a type-safe, programmatic, and robust interface to the Docker Engine API. This will simplify container lifecycle management, make the code easier to maintain, and is a prerequisite for implementing more complex orchestration logic like the migration endpoint.
      steps:
        - id: "9f6b987b-4d4e-4f3b-b2f7-2d17c5a083a2"
          status: "todo"
          name: "1. Install `dockerode` and update dependencies"
          reason: "To make the `dockerode` library available for use in the gateway service."
          files:
            - "gateway/package.json"
          operations:
            - "Add `dockerode` to the `dependencies` section in `gateway/package.json`."
            - "Remove `@types/dockerode` from `devDependencies` if it's there; the types should come with the main package or be installed alongside it."
        - id: "e1d2c3f4-a5b6-4c7d-8e9f-0a1b2c3d4e5f"
          status: "todo"
          name: "2. Rewrite `docker.service.ts` with `dockerode`"
          reason: "To replace all shell-based Docker commands with direct Docker API calls."
          files:
            - "gateway/src/docker.service.ts"
          operations:
            - "Import `Dockerode` and instantiate it: `const docker = new Dockerode();`."
            - "Rewrite `createAndStartContainer` to use `docker.createContainer()` and `container.start()`."
            - "In `createAndStartContainer`, configure the container creation to pull the image if it's not present using the `{ 'Image': DOCKER_IMAGE }` and `HostConfig`."
            - "Rewrite `stopAndRemoveContainer` to first find the container, then call `container.stop()` and `container.remove()`."
            - "Rewrite `findContainer` to use `docker.listContainers()` with a filter for the label `whatsapp-gateway-saas.instance-id` instead of relying on container names."
            - "Remove the now-redundant `pullImage` function."
      context_files:
        compact:
          - "gateway/src/docker.service.ts"
          - "gateway/package.json"
        medium:
          - "gateway/src/docker.service.ts"
          - "gateway/package.json"
          - "gateway/src/index.ts"
        extended:
          - "gateway/src/docker.service.ts"
          - "gateway/package.json"
          - "gateway/src/index.ts"
          - "providers/whatsmeow/docker-compose.yml"

    - id: "a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d"
      status: "todo"
      depends_on: ["d0c4e40d-d434-45e0-9411-a3f25d97793d"]
      name: "Part 2: Implement the Zero-Downtime Migration API Endpoint"
      reason: |
        The `README.md` prominently features a "Zero-Downtime Migration" capability, complete with a sample API call to `/api/instances/:id/migrate`. This is a cornerstone feature for a SaaS offering, but the endpoint and its orchestration logic are completely missing from the current codebase.

        This part will build upon the `dockerode` refactor to implement this critical feature. The underlying snapshot mechanism in the `whatsmeow` provider already exists; we just need to build the gateway-side orchestrator to manage the process.
      steps:
        - id: "s1t2e3p4-a1b2-4c3d-8e4f-5a6b7c8d9e0f"
          status: "todo"
          name: "1. Add the migration endpoint to `gateway/src/index.ts`"
          reason: "To expose the migration functionality via the public API as described in the README."
          files:
            - "gateway/src/index.ts"
          operations:
            - "Create a new endpoint `POST /api/instances/:id/migrate`."
            - "Add Elysia validation for the request body, which should contain a `target_node` (for now, we'll ignore this and assume a single node)."
            - "Perform ownership checks to ensure the user owns the instance they are trying to migrate."
        - id: "s5t6e7p8-b2c3-4d4e-8f5a-6b7c8d9e0f1a"
          status: "todo"
          name: "2. Implement the migration orchestration logic"
          reason: "To safely stop the old container, trigger its state backup, and start a new one that restores from that state."
          files:
            - "gateway/src/index.ts"
            - "gateway/src/docker.service.ts"
          operations:
            - "In the migration endpoint handler, call `stopAndRemoveContainer(instanceId)`. The `docker stop` command sends a `SIGTERM`, which the Go application is configured to catch, triggering `uploadStateSnapshot`."
            - "After the old container is removed, call `createAndStartContainer` with the same instance configuration."
            - "The new container's startup sequence will automatically call `fetchStateSnapshot`, restoring its session."
            - "Update the instance status in the database throughout the process (e.g., `migrating`, `running`)."
            - "Return a success response with the updated instance details."
      context_files:
        compact:
          - "gateway/src/index.ts"
          - "gateway/src/docker.service.ts"
          - "providers/whatsmeow/main.go"
        medium:
          - "gateway/src/index.ts"
          - "gateway/src/docker.service.ts"
          - "providers/whatsmeow/main.go"
          - "drizzle/schema.ts"
        extended:
          - "gateway/src/index.ts"
          - "gateway/src/docker.service.ts"
          - "providers/whatsmeow/main.go"
          - "drizzle/schema.ts"
          - "README.md"

    - id: "f9e8d7c6-b5a4-4938-a1f0-e9d8c7b6a5b4"
      status: "todo"
      depends_on: ["d0c4e40d-d434-45e0-9411-a3f25d97793d"]
      name: "Part 3: Add Instance Name to Schema and Container"
      reason: |
        Currently, instances are only identified by `id` and `phoneNumber`. Allowing users to assign a friendly name to an instance is a common SaaS feature that improves user experience. This name can also be used to name the Docker container, making `docker ps` output more human-readable for operators.
      steps:
        - id: "2c5a2c4e-5e78-4389-9e8c-5544d6731e05"
          status: "todo"
          name: "1. Update database schema to include an instance name"
          reason: "To persist the user-defined instance name in the database."
          files:
            - "drizzle/schema.ts"
          operations:
            - "Add a new `name` column to the `instances` table in `drizzle/schema.ts`. It should be a `varchar` and can be optional."
            - "Modify the `userPhoneIdx` unique index to be `uniqueIndex('user_phone_name_idx').on(table.userId, table.name)` if names must be unique per user, or add a new unique constraint if desired."
        - id: "4d1f5e8f-4d32-4e0d-85f0-6a7e025f190a"
          status: "todo"
          name: "2. Update API to support instance name"
          reason: "To allow users to create and update the instance name."
          files:
            - "gateway/src/index.ts"
          operations:
            - "In the `POST /instances` endpoint, add `name` to the request body validation and save it when creating a new instance."
        - id: "6b3e9b1d-0453-4871-b6a8-2b8e390c50d4"
          status: "todo"
          name: "3. Use instance name for the Docker container name"
          reason: "To improve operational observability by giving containers human-readable names."
          files:
            - "gateway/src/docker.service.ts"
          operations:
            - "Update `createAndStartContainer` to accept the instance name as an option."
            - "Construct a sanitized container name from the user's instance name and the instance ID to ensure uniqueness and prevent invalid characters (e.g., `instance-my-whatsapp-123`)."
            - "Use this new sanitized name when calling `docker.createContainer()`."
      context_files:
        compact:
          - "drizzle/schema.ts"
          - "gateway/src/index.ts"
          - "gateway/src/docker.service.ts"
        medium:
          - "drizzle/schema.ts"
          - "gateway/src/index.ts"
          - "gateway/src/docker.service.ts"
        extended:
          - "drizzle/schema.ts"
          - "gateway/src/index.ts"
          - "gateway/src/docker.service.ts"
          - "README.md"
  conclusion: |
    Upon completion of this plan, the application will be significantly more robust, secure, and maintainable. The brittle shell commands will be replaced by a modern, type-safe API client, eliminating a class of potential bugs and security issues.

    Most importantly, the gateway will deliver on the key architectural promise of zero-downtime migration, aligning the codebase with the `README.md` manifesto. The addition of user-defined instance names will improve both user experience and operational clarity. These changes move the project from a functional proof-of-concept to a production-ready, scalable SaaS platform.
  context_files:
    compact:
      - "gateway/src/docker.service.ts"
      - "gateway/src/index.ts"
      - "drizzle/schema.ts"
    medium:
      - "gateway/src/docker.service.ts"
      - "gateway/src/index.ts"
      - "drizzle/schema.ts"
      - "providers/whatsmeow/main.go"
      - "README.md"
    extended:
      - "gateway/src/docker.service.ts"
      - "gateway/src/index.ts"
      - "drizzle/schema.ts"
      - "providers/whatsmeow/main.go"
      - "README.md"
      - "gateway/package.json"
      - "providers/whatsmeow/Dockerfile"
